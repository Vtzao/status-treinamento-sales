<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Treinamentos Responsivo</title>
    <!-- Importa a biblioteca para criar os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PLUGIN ADICIONAL para mostrar os números dentro do gráfico -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <!-- Estilos para deixar o painel bonito e moderno -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7fa;
            color: #333;
            margin: 0;
            padding: 16px;
        }
        .container {
            width: 100%;
            max-width: 1400px;
            margin: auto;
            background: #ffffff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px; /* Reduzido para aproximar o timestamp */
        }
        .timestamp {
            text-align: center;
            color: #777;
            font-size: 0.9em;
            margin-bottom: 25px;
            min-height: 1.2em;
        }
        .filters-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            margin-bottom: 35px;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .filter-group > label {
            font-size: 1.1em;
            font-weight: 500;
            color: #34495e;
        }
        select {
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1em;
            background-color: #fff;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        select:hover {
            border-color: #3498db;
        }
        .checkbox-group input { display: none; }
        .checkbox-group label {
            padding: 8px 16px;
            border: 1px solid #ccc;
            border-radius: 20px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            user-select: none;
            display: inline-flex;
            align-items: center;
        }
        .checkbox-group input:checked + label {
            background-color: #74828f;
            color: #fff;
            border-color: #66798b;
        }
        /* Estilo para a nova tag "Concluído" */
        .completed-tag {
            font-size: 0.7em;
            font-weight: bold;
            color: rgb(255, 255, 255);
            background-color: rgb(0, 110, 106);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        .main-content {
            display: flex;
            gap: 40px;
            align-items: flex-start;
        }
        .chart-section {
            flex: 1;
            min-width: 350px;
        }
        .table-section {
            flex: 1.8;
            display: flex;
            flex-direction: column;
            min-width: 0;
            align-items: flex-start;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 440px;
            margin: 0 auto;
            cursor: pointer;
        }
        .table-wrapper {
            max-width: 100%;
            max-height: 65vh;
            overflow: auto;
            border: 1px solid #dfe6e9;
            border-radius: 8px;
        }
        #table-filter-status, .loading-status {
            text-align: center;
            color: #555;
            font-weight: 500;
            min-height: 24px;
            margin-top: 0;
        }
        #details-table {
            border-collapse: collapse;
            border-spacing: 0;
        }
        #details-table thead {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        #details-table th, #details-table td {
            border: none;
            border-bottom: 1px solid #dfe6e9;
            padding: 12px;
            text-align: left;
            white-space: nowrap;
        }
        #details-table th {
            background-color: #f1f5f8;
            font-weight: 600;
            color: #34495e;
        }
        #details-table th:nth-child(n+3), #details-table td:nth-child(n+3) {
             text-align: center;
        }
        #details-table td:nth-child(n+3) {
            font-size: 1.2em;
        }
        #details-table tr:last-child td { border-bottom: none; }
        #details-table tr:nth-child(even) { background-color: #f8f9fa; }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
                align-items: center;
            }
            .chart-section, .table-section {
                width: 100%;
            }
            .chart-section { max-width: 500px; }
            .table-section { align-items: stretch; }
        }
        @media (max-width: 600px) {
            .container { padding: 16px; }
            h1 { font-size: 1.5em; }
            .filter-group { gap: 10px; }
            .checkbox-group label { padding: 6px 12px; font-size: 0.9em; }
            .chart-container { height: 350px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>📊 Painel Interativo de Treinamentos</h1>
    <p id="last-updated-timestamp" class="timestamp"></p>

    <div class="filters-container">
        <div class="filter-group">
            <label>Cargo:</label>
            <select id="cargo-filter" disabled>
                <option>Carregando...</option>
            </select>
        </div>
        <div class="filter-group checkbox-group" id="module-filter-group">
            <!-- Checkboxes dos módulos serão inseridos aqui -->
        </div>
    </div>

    <div class="main-content">
        <div class="chart-section">
            <div class="chart-container">
                <canvas id="trainingChart"></canvas>
            </div>
        </div>
        <div class="table-section">
            <h2 id="table-filter-status" class="loading-status">Carregando dados da planilha...</h2>
            <div class="table-wrapper">
                <table id="details-table">
                    <thead id="table-header"></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- LINK DA SUA PLANILHA ---
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShdWRngNunn5QJT8L7o5_DtMzZSpXKgqpiv6X0xIT7O_LZbymmwqS-YhFR5rn1KLhnZ9wLp8RNvc_S/pub?output=csv';

    // --- VARIÁVEIS GLOBAIS ---
    let colaboradores = [];
    let tableClickFilter = null;
    let moduleCompletionStatus = {};
    const moduleMap = {
        acesso: 'Acesso',
        tarefas: 'Tarefas',
        relatorios: 'Relatórios',
        calendario: 'Calendário',
        leads: 'Leads',
        contas: 'Contas',
        contatos: 'Contatos'
    };
    const modules = Object.keys(moduleMap);

    const noDataPlugin = {
        id: 'noData',
        afterDraw: (chart) => {
            if (chart.data.datasets[0].data.length === 0) {
                const { ctx, width, height } = chart;
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = 'bold 16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
                ctx.fillStyle = '#666';
                ctx.fillText('Selecione um módulo para consulta', width / 2, height / 2);
                ctx.restore();
            }
        }
    };

    Chart.register(ChartDataLabels, noDataPlugin);

    const ctx = document.getElementById('trainingChart').getContext('2d');
    const trainingChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Treinados', 'Não Treinados', 'Agendados'],
            datasets: [{
                label: 'Status de Treinamento',
                data: [0, 0, 0],
                backgroundColor: ['rgb(0, 110, 106)', 'rgb(192, 0, 0)', 'rgb(255, 192, 0)'],
                borderColor: '#ffffff',
                borderWidth: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const clickedIndex = elements[0].index;
                    let newFilter = null;
                    if (clickedIndex === 0) newFilter = 'treinado';
                    if (clickedIndex === 1) newFilter = 'nao_treinado';
                    if (clickedIndex === 2) newFilter = 'agendado';
                    tableClickFilter = (tableClickFilter === newFilter) ? null : newFilter;
                    updateDashboard();
                }
            },
            plugins: {
                legend: { position: 'bottom', labels: { font: { size: 14 } } },
                title: { display: true, text: 'Distribuição de Treinamentos', font: { size: 18, weight: 'bold' }, padding: { top: 10, bottom: 20 } },
                datalabels: {
                    formatter: (value) => (value > 0 ? value : ''),
                    font: { weight: 'bold', size: 16 },
                    color: (context) => (context.dataIndex === 2 ? '#333' : '#fff'),
                }
            }
        }
    });

    const cargoFilter = document.getElementById('cargo-filter');
    const moduleFilterGroup = document.getElementById('module-filter-group');
    const tableHeader = document.getElementById('table-header');
    const tableBody = document.getElementById('table-body');
    const tableFilterStatus = document.getElementById('table-filter-status');
    const loadingStatus = document.querySelector('.loading-status');
    const timestampEl = document.getElementById('last-updated-timestamp');

    // <<-- LÓGICA ATUALIZADA AQUI -->>
    function getStatusFromValue(value) {
        const lowerCaseValue = (value || '').trim().toLowerCase();

        // 1. Verifica se está vazio ou contém a palavra "null"
        if (lowerCaseValue === '' || lowerCaseValue === 'null') {
            return 'nao_treinado';
        }

        // 2. Verifica se contém a palavra "agendado"
        if (lowerCaseValue.includes('agendado')) {
            return 'agendado';
        }

        // 3. Se não for nenhum dos acima, é considerado "treinado"
        return 'treinado';
    }

    async function loadDataFromSheet() {
        timestampEl.textContent = 'A carregar dados...';
        try {
            const response = await fetch(GOOGLE_SHEET_CSV_URL);
            if (!response.ok) throw new Error('Erro ao carregar a planilha.');

            const csvText = await response.text();
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

            const columnIndexes = {
                name: headers.indexOf('name'),
                cargo: headers.indexOf('cargo'),
                acesso: headers.indexOf('acesso ao user'),
                tarefas: headers.indexOf('tarefas'),
                relatorios: headers.indexOf('relatórios'),
                calendario: headers.indexOf('calendário c/ sinc outlook'),
                leads: headers.indexOf('leads'),
                contas: headers.indexOf('contas'),
                contatos: headers.indexOf('contatos')
            };

            colaboradores = lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                const cargo = values[columnIndexes.cargo] || 'Não definido';
                let grupo = 'Outros';
                if (cargo.toLowerCase().includes('diretor')) grupo = 'Diretor';
                else if (cargo.toLowerCase().includes('gerente')) grupo = 'Gerente';
                else if (cargo.toLowerCase().includes('gestor')) grupo = 'Gestor';
                else if (cargo.toLowerCase().includes('coordenador')) grupo = 'Coordenador';
                else if (cargo.toLowerCase().includes('analista')) grupo = 'Analista';

                const colaborador = { name: values[columnIndexes.name] || '', cargo: cargo, grupo: grupo };
                modules.forEach(mod => {
                    colaborador[mod] = getStatusFromValue(values[columnIndexes[mod]]);
                });
                return colaborador;
            });

            // Define o timestamp após o carregamento bem-sucedido
            const now = new Date();
            timestampEl.textContent = `Dados atualizados em: ${now.toLocaleDateString('pt-BR')} ${now.toLocaleTimeString('pt-BR')}`;

            analyzeModuleCompletion();
            populateCargoFilter();
            populateModuleFilter();
            loadingStatus.textContent = '';
            updateDashboard();

        } catch (error) {
            console.error('Erro:', error);
            loadingStatus.textContent = 'Falha ao carregar. Verifique o link e as permissões.';
            timestampEl.textContent = 'Falha ao carregar dados.';
        }
    }

    function analyzeModuleCompletion() {
        modules.forEach(mod => {
            if (colaboradores.length === 0) {
                moduleCompletionStatus[mod] = false;
                return;
            }
            const isCompleted = colaboradores.every(p => p[mod] === 'treinado');
            moduleCompletionStatus[mod] = isCompleted;
        });
    }

    function populateCargoFilter() {
        const grupos = [...new Set(colaboradores.map(p => p.grupo))].sort();
        cargoFilter.innerHTML = '<option value="Todos">Todos os Cargos</option>';
        grupos.forEach(grupo => {
            const option = document.createElement('option');
            option.value = grupo;
            if (grupo === 'Outros') option.textContent = 'Outros Cargos';
            else if (grupo.endsWith('r')) option.textContent = `${grupo}es`;
            else option.textContent = `${grupo}s`;
            cargoFilter.appendChild(option);
        });
        cargoFilter.disabled = false;
    }

    function populateModuleFilter() {
        moduleFilterGroup.innerHTML = '';
        modules.forEach(mod => {
            const checkboxId = `mod-${mod}`;
            const checkboxWrapper = document.createElement('span');
            const isCompleted = moduleCompletionStatus[mod];
            const completedTag = isCompleted ? '<span class="completed-tag">Concluído</span>' : '';

            checkboxWrapper.innerHTML = `
                <input type="checkbox" id="${checkboxId}" value="${mod}">
                <label for="${checkboxId}">${moduleMap[mod]}${completedTag}</label>
            `;
            checkboxWrapper.querySelector('input').addEventListener('change', () => {
                tableClickFilter = null;
                updateDashboard();
            });
            moduleFilterGroup.appendChild(checkboxWrapper);
        });
    }

    function updateDashboard() {
        const cargoFiltro = cargoFilter.value;
        const activeModules = Array.from(moduleFilterGroup.querySelectorAll('input:checked')).map(cb => cb.value);

        if (activeModules.length === 0) {
            trainingChart.data.datasets[0].data = [];
            trainingChart.options.plugins.title.display = false;
            trainingChart.options.plugins.legend.display = false;
            trainingChart.update();

            tableHeader.innerHTML = '<tr><th>Nome</th><th>Cargo</th></tr>';
            tableBody.innerHTML = `<tr><td colspan="2" style="text-align:center; padding: 20px;">Selecione os módulos que deseja visualizar na tabela.</td></tr>`;
            tableFilterStatus.textContent = '';
            return;
        }

        trainingChart.options.plugins.title.display = true;
        trainingChart.options.plugins.legend.display = true;

        const dataFilteredByCargo = (cargoFiltro === 'Todos')
            ? colaboradores
            : colaboradores.filter(p => p.grupo === cargoFiltro);

        const getOverallStatus = (p) => {
            const allStatuses = activeModules.map(mod => p[mod]);
            if (allStatuses.includes('nao_treinado')) return 'nao_treinado';
            if (allStatuses.includes('agendado')) return 'agendado';
            return 'treinado';
        };

        let treinados = 0, naoTreinados = 0, agendados = 0;
        dataFilteredByCargo.forEach(p => {
            const status = getOverallStatus(p);
            if (status === 'treinado') treinados++;
            else if (status === 'agendado') agendados++;
            else naoTreinados++;
        });

        trainingChart.data.datasets[0].data = [treinados, naoTreinados, agendados];
        trainingChart.options.plugins.title.text = `Distribuição (${dataFilteredByCargo.length} Pessoas)`;
        trainingChart.update();

        let tableData = dataFilteredByCargo;
        if (tableClickFilter) {
            tableData = dataFilteredByCargo.filter(p => getOverallStatus(p) === tableClickFilter);
            const statusText = { 'treinado': 'Treinados', 'nao_treinado': 'Não Treinados', 'agendado': 'Agendados' };
            tableFilterStatus.textContent = `Mostrando apenas: ${statusText[tableClickFilter]}`;
        } else {
            tableFilterStatus.textContent = '';
        }

        tableHeader.innerHTML = '';
        tableBody.innerHTML = '';

        let headerRow = '<tr>';
        headerRow += `<th>Nome</th>`;
        headerRow += `<th>Cargo</th>`;
        activeModules.forEach(mod => {
            headerRow += `<th>${moduleMap[mod]}</th>`;
        });
        headerRow += '</tr>';
        tableHeader.innerHTML = headerRow;

        const statusToIcon = { 'treinado': '✅', 'nao_treinado': '❌', 'agendado': '⏰' };

        if (tableData.length > 0) {
            tableData.forEach(p => {
                const row = document.createElement('tr');
                let cells = `<td>${p.name}</td><td>${p.cargo}</td>`;
                activeModules.forEach(mod => {
                    cells += `<td>${statusToIcon[p[mod]]}</td>`;
                });
                row.innerHTML = cells;
                tableBody.appendChild(row);
            });
        } else {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="${activeModules.length + 2}" style="text-align:center; padding: 20px;">Nenhum colaborador encontrado.</td>`;
            tableBody.appendChild(row);
        }
    }

    cargoFilter.addEventListener('change', () => { tableClickFilter = null; updateDashboard(); });

    window.onload = () => { loadDataFromSheet(); };

</script>

</body>
</html>
